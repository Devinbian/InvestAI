<template>
    <div class="shortcuts-bar" v-if="showShortcuts">
        <!-- PCÁ´ØÂø´Êç∑Êìç‰ΩúÊ†èÔºàÂàùÂßãÊ®°ÂºèÔºâ - Âè™Âú®PCÁ´ØÊòæÁ§∫ -->
        <div class="ai-suggestions" v-if="mode === 'initial' && !isMobileView">
            <div class="suggestion-row">
                <el-button v-for="shortcut in activeShortcuts" :key="shortcut.id" class="ai-suggestion-btn"
                    @click="handleShortcutClick(shortcut)">
                    <span class="btn-icon">{{ shortcut.icon }}</span>
                    {{ shortcut.title }}
                </el-button>
                <!-- Ëá™ÂÆö‰πâÊåâÈíÆ - ‰ΩéË∞ÉÊ†∑Âºè -->
                <button class="customize-btn-inline" @click="openCustomizeDialog" title="Ëá™ÂÆö‰πâÂø´Êç∑Êìç‰Ωú">
                    <span class="customize-icon">‚öôÔ∏è</span>
                </button>
            </div>
        </div>

        <!-- ÁßªÂä®Á´ØÂàùÂßãÊ®°ÂºèÈöêËóèÂç†‰ΩçÂÖÉÁ¥† - Á°Æ‰øùÁªÑ‰ª∂ÂßãÁªàË¢´Ê∏≤Êüì -->
        <div v-if="mode === 'initial' && isMobileView" style="display: none;" class="mobile-placeholder">
            <!-- ÈöêËóèÁöÑÂç†‰ΩçÂÖÉÁ¥†ÔºåÁ°Æ‰øùÁßªÂä®Á´ØÁªÑ‰ª∂ËÉΩË¢´Ê≠£Á°ÆÊ∏≤ÊüìÂíåÂºïÁî® -->
        </div>

        <!-- PCÁ´ØÂø´Êç∑Êìç‰ΩúÊ†èÔºàËÅäÂ§©Ê®°Âºè‰∏ãÊòæÁ§∫Âú®ËæìÂÖ•Ê°Ü‰∏äÊñπÔºâ -->
        <div class="chat-shortcuts pc-shortcuts" v-if="mode === 'chat' && showChatShortcuts && !isMobileView">
            <div class="shortcuts-grid" :style="{
                display: 'grid !important',
                gridTemplateColumns: 'repeat(5, 1fr) !important',
                gap: '6px !important',
                width: '100% !important',
                maxWidth: 'none !important',
                margin: '0 !important',
                padding: '0 !important',
                boxSizing: 'border-box !important'
            }">
                <el-button v-for="shortcut in activeShortcuts" :key="shortcut.id" class="chat-shortcut-btn"
                    @click="handleShortcutClick(shortcut)" :style="{
                        width: '100%',
                        height: '40px',
                        minWidth: '0',
                        maxWidth: 'none',
                        margin: '0',
                        padding: '4px 2px',
                        boxSizing: 'border-box',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        justifyContent: 'center',
                        gap: '1px',
                        fontSize: '12px'
                    }">
                    <span class="btn-icon" :style="{ fontSize: '14px', lineHeight: '1' }">{{ shortcut.icon }}</span>
                    <span class="btn-text" :style="{ fontSize: '10px', lineHeight: '1.2', fontWeight: '500' }">{{
                        shortcut.shortTitle || shortcut.title }}</span>
                </el-button>
                <el-button class="chat-shortcut-btn customize-btn-chat" @click="openCustomizeDialog" :style="{
                    width: '100%',
                    height: '40px',
                    minWidth: '0',
                    maxWidth: 'none',
                    margin: '0',
                    padding: '6px 8px',
                    boxSizing: 'border-box',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '1px',
                    fontSize: '12px'
                }">
                    <span class="btn-icon" :style="{ fontSize: '14px', lineHeight: '1' }">‚öôÔ∏è</span>
                    <span class="btn-text" :style="{ fontSize: '10px', lineHeight: '1.2', fontWeight: '500' }">ËÆæÁΩÆ</span>
                </el-button>
                <el-button class="chat-shortcut-btn close-btn" @click="toggleChatShortcuts" :style="{
                    width: '100%',
                    height: '40px',
                    minWidth: '0',
                    maxWidth: 'none',
                    margin: '0',
                    padding: '6px 8px',
                    boxSizing: 'border-box',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '1px',
                    fontSize: '12px'
                }">
                    <span class="btn-icon" :style="{ fontSize: '14px', lineHeight: '1' }">‚úï</span>
                    <span class="btn-text" :style="{ fontSize: '10px', lineHeight: '1.2', fontWeight: '500' }">Êî∂Ëµ∑</span>
                </el-button>
            </div>
        </div>

        <!-- ÁßªÂä®Á´ØÂø´Êç∑Êìç‰ΩúÊ†èÔºàÂéüÁîüËÆæËÆ°Ôºâ -->
        <div class="mobile-shortcuts-overlay" v-if="showChatShortcuts && isMobileView" @click="toggleChatShortcuts">
            <div class="mobile-shortcuts-container" @click.stop>
                <!-- È°∂ÈÉ®ÊãñÊãΩÊåáÁ§∫Âô® -->
                <div class="drag-indicator"></div>

                <!-- Ê†áÈ¢òÂå∫Âüü -->
                <div class="shortcuts-header">
                    <h3 class="shortcuts-title">Âø´Êç∑Êìç‰Ωú</h3>
                    <button class="close-btn-header" @click="toggleChatShortcuts">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                    </button>
                </div>

                <!-- Âø´Êç∑Êìç‰ΩúÁΩëÊ†º -->
                <div class="shortcuts-grid-mobile">
                    <div v-for="shortcut in activeShortcuts" :key="shortcut.id" class="shortcut-item-mobile"
                        @click="handleShortcutClick(shortcut)">
                        <div class="shortcut-icon">{{ shortcut.icon }}</div>
                        <div class="shortcut-text">{{ shortcut.shortTitle || shortcut.title }}</div>
                    </div>

                    <!-- Ëá™ÂÆö‰πâÊåâÈíÆ -->
                    <div class="shortcut-item-mobile add-shortcut" @click="openCustomizeDialog">
                        <div class="shortcut-icon add-icon">+</div>
                        <div class="shortcut-text">Ëá™ÂÆö‰πâ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, computed, onMounted, watch, nextTick } from 'vue';
import { ElMessage } from 'element-plus';

// PropsÂÆö‰πâ
const props = defineProps({
    // ÊòæÁ§∫Ê®°ÂºèÔºö'initial' | 'chat'
    mode: {
        type: String,
        default: 'initial',
        validator: (value) => ['initial', 'chat'].includes(value)
    },
    // ÊòØÂê¶ÊòæÁ§∫Âø´Êç∑Êìç‰ΩúÊ†è
    showShortcuts: {
        type: Boolean,
        default: true
    },
    // ÊòØÂê¶ÊòæÁ§∫ËÅäÂ§©Âø´Êç∑Êìç‰ΩúÔºà‰ªÖÂú®chatÊ®°Âºè‰∏ãÊúâÊïàÔºâ
    showChatShortcuts: {
        type: Boolean,
        default: false
    },
    // ÊòØÂê¶‰∏∫ÁßªÂä®Á´ØËßÜÂõæ
    isMobileView: {
        type: Boolean,
        default: false
    },
    // ÊòØÂê¶Â∑≤ÁôªÂΩï
    isLoggedIn: {
        type: Boolean,
        default: false
    }
});

// EmitsÂÆö‰πâ
const emit = defineEmits([
    'shortcut-click',
    'customize-dialog-open',
    'toggle-chat-shortcuts',
    'shortcuts-updated'
]);

// ÈªòËÆ§Âø´Êç∑Êìç‰ΩúÈÖçÁΩÆ
const defaultShortcuts = ref([
    {
        id: 'smart_review',
        icon: 'üìä',
        title: 'Êô∫ËÉΩÂ§çÁõò',
        shortTitle: 'Â§çÁõò',
        description: 'Êô∫ËÉΩÂàÜÊûêÂ∏ÇÂú∫Ë°®Áé∞ÂíåÊäïËµÑÁ≠ñÁï•',
        action: 'smart_review',
        isDefault: true,
        isActive: true
    },
    {
        id: 'watchlist',
        icon: '‚≠ê',
        title: 'Ëá™ÈÄâËÇ°',
        shortTitle: 'Ëá™ÈÄâ',
        description: 'Êü•ÁúãÂíåÁÆ°ÁêÜÊàëÁöÑËá™ÈÄâËÇ°Á•®',
        action: 'watchlist',
        isDefault: true,
        isActive: true
    },
    {
        id: 'smart_recommendation',
        icon: 'üìà',
        title: 'Êô∫ËÉΩËçêËÇ°',
        shortTitle: 'ËçêËÇ°',
        description: 'Âü∫‰∫éAIÁÆóÊ≥ïÊé®Ëçê‰ºòË¥®ËÇ°Á•®',
        action: 'smart_recommendation',
        isDefault: true,
        isActive: true
    },
    {
        id: 'news_update',
        icon: 'üìÑ',
        title: 'ËµÑËÆØÊé®ÈÄÅ',
        shortTitle: 'ËµÑËÆØ',
        description: 'Ëé∑ÂèñÊúÄÊñ∞Â∏ÇÂú∫ËµÑËÆØÂíåÈáçË¶ÅÂÖ¨Âëä',
        action: 'news_update',
        isDefault: true,
        isActive: true
    },
    {
        id: 'asset_analysis',
        icon: 'üíº',
        title: 'ÊàëÁöÑËµÑ‰∫ß',
        shortTitle: 'ËµÑ‰∫ß',
        description: 'Êü•ÁúãÊäïËµÑÁªÑÂêàÂíåË¥¶Êà∑ÂàÜÊûê',
        action: 'asset_analysis',
        isDefault: true,
        isActive: true
    }
]);

// ÂΩìÂâçÊøÄÊ¥ªÁöÑÂø´Êç∑Êìç‰Ωú
const activeShortcuts = ref([]);

// Âø´Êç∑Êìç‰ΩúÊï∞ÊçÆÁÆ°ÁêÜÁ±ª
class ShortcutsManager {
    static getDefaultStates() {
        const saved = localStorage.getItem('defaultShortcutStates');
        return saved ? JSON.parse(saved) : {};
    }

    static getCustomShortcuts() {
        const saved = localStorage.getItem('customShortcuts');
        return saved ? JSON.parse(saved) : [];
    }

    static loadActiveShortcuts(defaultShortcuts) {
        const result = [];
        const states = this.getDefaultStates();

        // Ê∑ªÂä†ÊøÄÊ¥ªÁöÑÈªòËÆ§Âø´Êç∑Êìç‰Ωú
        const activeDefaults = defaultShortcuts.filter(s => {
            if (states.hasOwnProperty(s.id)) {
                s.isActive = states[s.id];
            }
            return s.isActive;
        });
        result.push(...activeDefaults);

        // Ê∑ªÂä†ÊøÄÊ¥ªÁöÑËá™ÂÆö‰πâÂø´Êç∑Êìç‰Ωú
        const customShortcuts = this.getCustomShortcuts();
        const activeCustoms = customShortcuts
            .filter(s => s.isActive)
            .map(shortcut => ({ ...shortcut, action: 'custom' }));
        result.push(...activeCustoms);

        return result;
    }
}

// ÂàùÂßãÂåñÂø´Êç∑Êìç‰Ωú
const initializeShortcuts = () => {
    console.log('üîÑ ShortcutsBar - ÂàùÂßãÂåñÂø´Êç∑Êìç‰Ωú');
    activeShortcuts.value = ShortcutsManager.loadActiveShortcuts(defaultShortcuts.value);
    console.log('‚úÖ ShortcutsBar - Âø´Êç∑Êìç‰ΩúÂàùÂßãÂåñÂÆåÊàêÔºåÊÄªÊï∞:', activeShortcuts.value.length);
};

// Âø´Êç∑Êìç‰ΩúÁÇπÂáªÂ§ÑÁêÜ
const handleShortcutClick = (shortcut) => {
    console.log('üöÄ ShortcutsBar - ÁÇπÂáªÂø´Êç∑Êìç‰Ωú:', shortcut);
    emit('shortcut-click', shortcut);
};

// ÊâìÂºÄËá™ÂÆö‰πâÂØπËØùÊ°Ü
const openCustomizeDialog = () => {
    emit('customize-dialog-open');
};

// ÂàáÊç¢ËÅäÂ§©Âø´Êç∑Êìç‰ΩúÊòæÁ§∫Áä∂ÊÄÅ
const toggleChatShortcuts = () => {
    emit('toggle-chat-shortcuts');
};

// Â§ÑÁêÜÂø´Êç∑Êìç‰ΩúÊõ¥Êñ∞
const handleShortcutsUpdated = () => {
    console.log('üîÑ ShortcutsBar - Â§ÑÁêÜÂø´Êç∑Êìç‰ΩúÊõ¥Êñ∞‰∫ã‰ª∂');
    // Âº∫Âà∂Ê∏ÖÁ©∫Êï∞ÁªÑÔºåÁ°Æ‰øùÂìçÂ∫îÂºèÊõ¥Êñ∞
    activeShortcuts.value = [];

    // ‰ΩøÁî®nextTickÁ°Æ‰øùDOMÊõ¥Êñ∞ÂêéÂÜçÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
    nextTick(() => {
        initializeShortcuts();
        emit('shortcuts-updated');
        console.log('‚úÖ ShortcutsBar - Âø´Êç∑Êìç‰ΩúÊõ¥Êñ∞ÂÆåÊàê');
    });
};

// ÁõëÂê¨propsÂèòÂåñÔºåÈáçÊñ∞ÂàùÂßãÂåñÂø´Êç∑Êìç‰Ωú
watch(() => props.isLoggedIn, initializeShortcuts, { immediate: false });

// ÁõëÂê¨ÁßªÂä®Á´ØÂø´Êç∑Êìç‰ΩúÂºπÁ™óÊòæÁ§∫Áä∂ÊÄÅ
watch(() => props.showChatShortcuts, (newVal, oldVal) => {
    if (newVal && props.isMobileView && !oldVal) {
        console.log('üì± ShortcutsBar - ÁßªÂä®Á´ØÂø´Êç∑Êìç‰ΩúÂºπÁ™óÊâìÂºÄÔºåÈáçÊñ∞ÂàùÂßãÂåñÊï∞ÊçÆ');
        initializeShortcuts();
    }
}, { immediate: false });

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂ÂàùÂßãÂåñ
onMounted(() => {
    console.log('üîß ShortcutsBar - ÁªÑ‰ª∂Â∑≤ÊåÇËΩΩ', {
        mode: props.mode,
        showShortcuts: props.showShortcuts,
        isMobileView: props.isMobileView,
        isLoggedIn: props.isLoggedIn
    });
    initializeShortcuts();
});

// Êö¥Èú≤ÊñπÊ≥ïÁªôÁà∂ÁªÑ‰ª∂
defineExpose({
    initializeShortcuts,
    handleShortcutsUpdated
});
</script>

<style scoped>
/* ÂºïÂÖ•ÂÖ±‰∫´ÁöÑÂø´Êç∑Êìç‰ΩúÊ†∑Âºè */
@import '@/styles/components/shortcuts.scss';

/* ÁßªÂä®Á´ØÈöêËóèÂç†‰ΩçÂÖÉÁ¥† */
.mobile-placeholder {
    display: none;
}

@media (max-width: 480px) {
    .ai-suggestion-btn {
        min-width: auto;
        flex: 1;
    }

    /* Ë∂ÖÂ∞èÂ±èÂπï‰ºòÂåñÁßªÂä®Á´ØÂºπÁ™ó */
    .shortcuts-grid-mobile {
        grid-template-columns: repeat(3, 1fr);
        padding: 16px 12px 12px;
    }

    .shortcut-item-mobile {
        padding: 12px 6px;
        min-height: 72px;
    }

    .shortcut-icon {
        width: 40px;
        height: 40px;
        font-size: 18px;
        margin-bottom: 6px;
    }

    .shortcut-text {
        font-size: 11px;
    }

    .shortcuts-header {
        padding: 12px 16px 8px;
    }

    .shortcuts-title {
        font-size: 15px;
    }

    .close-btn-header {
        width: 28px;
        height: 28px;
    }

    .close-btn-header svg {
        width: 16px;
        height: 16px;
    }
}
</style>
