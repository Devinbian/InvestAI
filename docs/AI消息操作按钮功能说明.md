# AI消息操作按钮功能说明

## 功能概述

为AI回复消息气泡添加了复制和重新生成两个常用操作按钮，提升用户体验和交互便利性。

## 功能特性

### 1. 复制功能

- **位置**：每条AI回复消息的底部
- **图标**：复制图标（双文档样式）
- **功能**：一键复制AI回复的完整文本内容到剪贴板
- **状态反馈**：
  - 默认状态：显示"复制"
  - 复制中：显示"复制中..."
  - 成功状态：显示"已复制"（2秒后恢复）
  - 失败状态：显示"复制失败"（2秒后恢复）
- **兼容性**：支持现代浏览器的Clipboard API，并提供传统方法降级

### 2. 重新生成功能

- **位置**：每条AI回复消息的底部
- **图标**：刷新图标（循环箭头样式）
- **功能**：重新生成AI回复
- **工作流程**：
  1. 找到对应的用户消息（如果没有则根据AI消息特征智能推断）
  2. 清空当前AI消息内容并设置为生成中状态
  3. 短暂延迟让用户看到清空效果
  4. 直接调用API生成新回复（不在聊天记录中重复用户消息）
  5. 流式更新AI回复内容

### 3. 分享功能

- **位置**：在"重新生成"按钮后面
- **图标**：分享图标（三个连接的圆圈）
- **功能**：将当前AI消息生成海报图片

## 技术实现

### 模板结构

```vue
<!-- AI消息操作按钮（放在消息气泡外面） -->
<div v-if="message.role === 'assistant' && message.content && !message.isGenerating"
    class="message-actions-external">
    <div class="action-buttons">
        <el-button size="small" text @click="handleCopyMessage(message)"
            class="action-btn copy-btn">
            <!-- 复制图标和文本 -->
        </el-button>
        <el-button size="small" text @click="handleRegenerateMessage(message)"
            class="action-btn regenerate-btn">
            <!-- 重新生成图标和文本 -->
        </el-button>
        <el-button size="small" text @click="handleShareMessage(message)"
            class="action-btn share-btn">
            <!-- 分享图标和文本 -->
        </el-button>
    </div>
</div>
```

### 核心方法

#### 复制消息方法

```javascript
const handleCopyMessage = async (message) => {
  // 1. 防重复点击保护
  // 2. 使用Clipboard API或降级方案
  // 3. 状态管理和用户反馈
  // 4. 错误处理
};
```

#### 重新生成方法

```javascript
const handleRegenerateMessage = async (message) => {
  // 1. 定位消息位置
  // 2. 找到对应用户消息
  // 3. 清理聊天历史
  // 4. 重新发送请求
};
```

#### 分享消息方法

```javascript
const handleShareMessage = async (message) => {
    try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // 设置画布尺寸
        const width = 800;
        const height = 1200;
        canvas.width = width;
        canvas.height = height;
        
        // 绘制背景、Logo、内容等
        // ...
        
        // 转换为图片并下载
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `InvestAI-分享-${new Date().getTime()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 'image/png');
        
    } catch (error) {
        console.error('分享图片生成失败:', error);
    }
};
```

### 状态管理

使用Map结构存储每条消息的复制状态：

```javascript
const messageCopyStates = ref(new Map());
```

## 样式设计

### 交互设计

- **按钮位置**：放置在AI消息气泡外部底部，独立一行显示在消息气泡下方
- **显示逻辑**：
  - 桌面端：鼠标悬停时显示（opacity: 0 → 1）
  - 移动端：始终显示（opacity: 1）
- **按钮样式**：轻量化设计，不干扰阅读
- **悬停效果**：微妙的颜色变化和上移动画

### 响应式适配

- **桌面端**：按钮较小，左对齐，与消息气泡保持48px左边距对齐
- **移动端**：按钮较大，居中显示，无额外左边距，增加触摸友好性

### 颜色主题

- **复制按钮**：蓝色主题（#3b82f6）
- **重新生成按钮**：绿色主题（#10b981）
- **分享按钮**：紫色主题（#8b5cf6）
- **默认状态**：灰色（#6b7280）

## 用户体验优化

### 1. 渐进式显示

- 桌面端按需显示，减少视觉干扰
- 移动端常驻显示，方便触摸操作

### 2. 状态反馈

- 复制操作提供实时状态反馈
- 重新生成操作显示进度提示
- 错误处理和用户友好的错误信息

### 3. 性能优化

- 按钮状态使用Map存储，避免响应式开销
- 防抖处理，避免重复操作
- 内存清理，避免状态累积

## 兼容性考虑

### 浏览器兼容性

- **现代浏览器**：使用Clipboard API
- **传统浏览器**：降级到document.execCommand
- **安全上下文**：HTTPS环境优先使用现代API

### 移动端适配

- **触摸友好**：增大按钮尺寸
- **视觉优化**：调整间距和字体大小
- **交互优化**：移除悬停依赖

## 使用场景

1. **内容分享**：快速复制AI回复分享给他人
2. **内容编辑**：复制AI回复到其他应用进行编辑
3. **结果优化**：对不满意的回复进行重新生成
4. **多轮对话**：在对话中快速重试某个回复

## 智能推断机制

对于通过快捷操作生成的消息（如智能荐股、资讯推送等），系统会智能推断原始请求：

- **智能荐股**：检测 `hasStockInfo`、`stockList` 属性或内容关键词
- **资讯推送**：检测 `isNewsUpdate` 属性或内容关键词
- **资产分析**：检测 `hasAssetInfo`、`assetData` 属性或内容关键词
- **自选股查看**：检测 `isWatchlistDisplay`、`watchlistData` 属性或内容关键词
- **通用回复**：无法推断时使用默认的重新生成请求

## 注意事项

1. **重新生成影响**：只替换当前消息，不影响其他聊天记录
2. **复制内容**：复制的是原始文本，不包含格式
3. **状态持久性**：复制状态不会持久化，刷新页面后重置
4. **权限要求**：复制功能需要剪贴板访问权限
5. **智能推断**：系统会自动识别消息类型，无需手动指定原始请求

## 未来扩展

1. **更多操作**：编辑、删除、收藏等
2. **格式选择**：支持复制HTML格式
3. **批量操作**：选择多条消息进行操作
4. **快捷键**：添加键盘快捷键支持

## 海报样式设计

### 整体布局
- **尺寸**：750x1000像素，聊天界面风格，适合移动端分享
- **背景**：纯白色背景，简洁干净
- **结构**：标题区域 + 对话气泡 + 品牌信息区域

### 顶部设计
- **标题**：动态标题（AI智能分析/投资分析报告/智能推荐等）
- **时间信息**：显示生成时间和AI生成声明
- **分割线**：简洁的水平分割线

### 对话区域
- **用户输入气泡**：
  - 蓝色背景（#007AFF），白色文字
  - 参照真实聊天气泡样式（右下角小圆角）
  - 位于右侧，智能推断用户输入内容
  - 动态调整宽度适应文字长度
- **AI回复区域**：
  - 无头像设计，更简洁
  - AI回复气泡：浅灰色背景（#f1f3f4）
  - 参照真实聊天气泡样式（左下角小圆角）
  - 消息内容：16px字体，24px行高
  - 智能换行，完整显示所有内容
  - 动态调整气泡大小适应内容

### 底部设计
- **品牌信息**：
  - "InvestAI" 品牌名称
  - "你的AI投资助手，助力智能投资决策"
- **二维码**：
  - 圆角背景，带边框
  - 简化的网格图案
  - 中心带有📊图标的Logo
- **高质量输出**：95%质量的PNG格式

## 使用说明

### 前置条件
- 浏览器支持Canvas API
- 消息内容不为空
- 非生成中状态

### 操作步骤
1. 在AI消息下方找到操作按钮区域
2. 点击"分享"按钮（分享图标）
3. 等待海报生成完成（显示"生成中..."状态）
4. 在弹出的预览窗口中查看生成的海报
5. 点击"下载图片"按钮保存到本地
6. 或点击"取消"关闭预览窗口

### 预览功能特点
- **全屏预览**：弹窗覆盖整个屏幕，提供最佳预览体验
- **实时预览**：生成后立即显示预览效果
- **高质量显示**：预览图片与最终下载图片一致
- **用户确认**：用户可以预览后决定是否下载
- **响应式设计**：在桌面端和移动端都有良好的预览体验
- **内存管理**：关闭预览后自动释放图片资源
- **真实气泡样式**：海报中的消息气泡完全参照当前聊天界面样式

### 注意事项
- 长文本会自动截断并添加省略号
- 图片格式为PNG，支持透明度
- 生成的海报包含品牌标识
- 文件大小通常在100-500KB之间
- 预览窗口支持ESC键关闭

## 技术细节

### 依赖项
- Canvas API（浏览器原生）
- Blob API（文件生成）
- URL.createObjectURL（下载处理）

### 兼容性
- 现代浏览器（Chrome、Firefox、Safari、Edge）
- 移动端浏览器支持
- 不支持IE浏览器

### 性能考虑
- 异步处理避免UI阻塞
- 内存管理（及时释放URL对象）
- 错误边界处理

## 未来优化

### 功能扩展
- [ ] 支持自定义海报模板
- [ ] 添加二维码分享
- [ ] 支持社交媒体直接分享
- [ ] 批量消息海报生成

### 技术优化
- [ ] WebWorker处理大图片
- [ ] 图片压缩优化
- [ ] 缓存机制减少重复生成
- [ ] 更丰富的字体支持

### 用户体验
- [ ] 海报预览功能
- [ ] 自定义水印
- [ ] 多种尺寸选择
- [ ] 分享统计功能

## 版本更新记录

### v1.1.0 (2024-01-XX) - 优化版本
**主要改进：**
1. **预览弹窗尺寸优化**：
   - 从全屏改为适中尺寸（600px宽度）
   - 移动端适配（95vw x 85vh）
   - 更好的用户体验，不会完全覆盖界面

2. **海报标题动态化**：
   - 使用当前会话的真实标题
   - 不再使用固定的推断标题
   - 通过`sessionTitle` prop传递当前聊天标题

3. **用户消息准确性**：
   - 显示分享消息前一条的真实用户消息
   - 新增`getPreviousUserMessage()`函数
   - 从聊天历史中准确获取用户输入内容

**技术实现：**
- 在`ChatMessage.vue`中添加新的props：`sessionTitle`、`chatHistory`、`messageIndex`
- 在`Main.vue`中添加`currentChatTitle`计算属性
- 优化CSS样式，移除全屏相关样式
- 改进预览弹窗的响应式设计

**用户体验提升：**
- 预览弹窗不再占据整个屏幕
- 海报内容更加准确和个性化
- 移动端预览体验更佳
