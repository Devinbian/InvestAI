# 移动端底部聊天框优化说明

## 问题描述

在移动端浏览器中，底部输入框（包括聊天模式的输入区域和主界面的AI输入卡片）经常被浏览器的底部工具栏遮挡，影响用户体验。

## 解决方案

### 1. 智能浏览器检测

- **iOS Safari**: 底部工具栏最小80px，最大140px偏移
- **iOS Chrome**: 底部工具栏最小90px，最大150px偏移
- **Android Chrome**: 底部工具栏60-90px偏移
- **微信浏览器**: 使用较小偏移量（基础偏移的70%）

### 2. 双模式适配

#### 聊天模式

- 调整 `.input-area` 的 `bottom` 位置
- 使用 `position: fixed` 确保输入框始终可见
- 添加硬件加速优化性能

#### 主界面模式

- 调整 `.ai-card` 的 `padding-bottom` 间距
- 确保AI输入卡片不被底部工具栏遮挡
- 保持卡片的响应式布局

### 3. 动态检测机制

- **visualViewport API**: 实时检测可视区域变化
- **屏幕高度对比**: 计算浏览器工具栏占用空间
- **iOS安全区域**: 检测底部安全区域和工具栏状态

### 4. 多重事件监听

- `visualViewport` 变化监听
- 窗口尺寸变化监听
- 屏幕方向变化监听
- 焦点变化监听（虚拟键盘）
- 页面可见性变化监听
- 页面聚焦监听

### 5. 防抖优化

使用防抖函数避免频繁重计算，提升性能：

```javascript
const handleViewportChange = debounce(() => {
  if (isMobileView.value) {
    fixMobileChatBox();
  }
}, 150);
```

## 核心代码逻辑

### 浏览器检测

```javascript
const isIOS = /iphone|ipad|ipod/.test(userAgent);
const isAndroid = /android/.test(userAgent);
const isSafari = /safari/.test(userAgent) && !/chrome/.test(userAgent);
const isChrome = /chrome/.test(userAgent);
```

### 偏移量计算

```javascript
if (isIOS) {
  if (isSafari) {
    baseOffset = hasBottomBar
      ? Math.max(toolbarHeight + 40, 120)
      : Math.max(baseOffset, 80);
  } else if (isChrome) {
    baseOffset = hasBottomBar
      ? Math.max(toolbarHeight + 50, 130)
      : Math.max(baseOffset, 90);
  }
}
```

### 样式应用

#### 聊天模式

```javascript
if (inputArea && isChatMode.value) {
  inputArea.style.cssText += `
        bottom: ${finalOffset}px !important;
        position: fixed !important;
        width: 100% !important;
    `;
}
```

#### 主界面模式

```javascript
if (aiCard && !isChatMode.value) {
  aiCard.style.cssText += `
        padding-bottom: ${finalOffset}px !important;
        box-sizing: border-box !important;
    `;
}
```

## CSS层面辅助

```css
/* iOS设备特殊处理 */
@supports (-webkit-touch-callout: none) {
  .ai-card {
    padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)) !important;
  }
}

/* 使用现代CSS环境变量 */
.ai-card {
  padding-bottom: calc(
    env(keyboard-inset-height, 0px) + env(safe-area-inset-bottom, 0px) + 20px
  ) !important;
}
```

## 调试工具

提供移动端调试面板（🐛按钮），显示：

- 浏览器类型和版本
- 屏幕尺寸信息
- 工具栏高度检测
- 实际应用的偏移量
- 强制修复功能

## 兼容性

- ✅ iOS Safari 14+
- ✅ iOS Chrome 90+
- ✅ Android Chrome 80+
- ✅ 微信内置浏览器
- ✅ 其他现代移动浏览器

## 性能优化

- 防抖函数减少频繁计算
- 硬件加速优化渲染
- 条件执行避免不必要操作
- 延迟执行确保DOM完全渲染

## 测试建议

1. 在不同iOS设备上测试Safari和Chrome
2. 在不同Android设备上测试Chrome
3. 在微信中测试内置浏览器
4. 测试横竖屏切换场景
5. 测试虚拟键盘弹出场景
6. 使用调试面板查看实际数值
