<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>移动端聊天框调试工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .header {
            background: #007AFF;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }

        .debug-info {
            background: #fff;
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            line-height: 1.4;
            max-height: 200px;
            overflow-y: auto;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-history {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
        }

        .user-message {
            background: #007AFF;
            color: white;
            margin-left: auto;
        }

        .ai-message {
            background: #f0f0f0;
            color: #333;
        }

        .input-area {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 16px;
            display: flex;
            gap: 10px;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
        }

        .input-field {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 16px;
            outline: none;
        }

        .send-btn {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .controls {
            background: #f8f8f8;
            padding: 10px;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-good { background: #34C759; }
        .status-warning { background: #FF9500; }
        .status-error { background: #FF3B30; }

        /* 聊天模式样式 */
        .chatting .chat-history {
            height: calc(100vh - 76px - 280px);
            height: calc(100dvh - 76px - 280px);
            padding-bottom: 40px;
        }

        @media (max-width: 480px) {
            .chatting .chat-history {
                height: calc(100vh - 76px - 250px);
                height: calc(100dvh - 76px - 250px);
                padding-bottom: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            移动端聊天框调试工具
        </div>
        
        <div class="debug-info" id="debugInfo">
            正在加载调试信息...
        </div>
        
        <div class="chat-area">
            <div class="chat-history" id="chatHistory">
                <div class="message ai-message">
                    你好！我是AI助手，有什么可以帮助你的吗？
                </div>
            </div>
        </div>
        
        <div class="input-area" id="inputArea">
            <input type="text" class="input-field" id="messageInput" placeholder="输入消息..." />
            <button class="send-btn" onclick="sendMessage()">
                ➤
            </button>
        </div>
        
        <div class="controls">
            <button class="control-btn" onclick="toggleChatMode()">切换聊天模式</button>
            <button class="control-btn" onclick="scrollToBottom()">滚动到底部</button>
            <button class="control-btn" onclick="fixLayout()">修复布局</button>
            <button class="control-btn" onclick="resetLayout()">重置布局</button>
            <button class="control-btn" onclick="addTestMessage()">添加测试消息</button>
            <button class="control-btn" onclick="clearMessages()">清空消息</button>
        </div>
    </div>

    <script>
        let isChatMode = false;
        let messageCount = 0;

        function updateDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const inputArea = document.getElementById('inputArea');
            const chatHistory = document.getElementById('chatHistory');
            
            let inputRect = null;
            let chatRect = null;
            if (inputArea) {
                inputRect = inputArea.getBoundingClientRect();
            }
            if (chatHistory) {
                chatRect = chatHistory.getBoundingClientRect();
            }

            const inputVisible = inputRect && inputRect.bottom <= window.innerHeight && inputRect.top >= 0;
            const inputOverflow = inputRect ? Math.max(0, inputRect.bottom - window.innerHeight) : 0;
            
            debugInfo.innerHTML = `
                <div><span class="status-indicator ${inputVisible ? 'status-good' : 'status-error'}"></span><strong>输入框状态: ${inputVisible ? '完全可见' : '被遮挡'}</strong></div>
                <div><strong>视口:</strong> ${window.innerWidth}×${window.innerHeight}px ${window.visualViewport ? `(实际: ${window.visualViewport.width}×${window.visualViewport.height}px)` : ''}</div>
                <div><strong>输入框:</strong> ${inputRect ? `top:${Math.round(inputRect.top)} bottom:${Math.round(inputRect.bottom)} height:${Math.round(inputRect.height)}px` : '未找到'}</div>
                <div><strong>被遮挡:</strong> ${inputOverflow}px</div>
                <div><strong>聊天区域:</strong> ${chatRect ? `${Math.round(chatRect.height)}px (计算: ${getComputedStyle(chatHistory).height})` : '未找到'}</div>
                <div><strong>模式:</strong> ${isChatMode ? '聊天模式' : '普通模式'}</div>
                <div><strong>滚动:</strong> ${Math.round(window.scrollY)}px / ${document.documentElement.scrollHeight}px</div>
                <div><strong>UA:</strong> ${navigator.userAgent.includes('Mobile') ? '移动端' : '桌面端'}</div>
            `;
        }

        function toggleChatMode() {
            isChatMode = !isChatMode;
            const container = document.querySelector('.container');
            if (isChatMode) {
                container.classList.add('chatting');
            } else {
                container.classList.remove('chatting');
            }
            
            setTimeout(() => {
                fixLayout();
                updateDebugInfo();
            }, 100);
        }

        function scrollToBottom() {
            const chatHistory = document.getElementById('chatHistory');
            if (chatHistory) {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        function fixLayout() {
            const inputArea = document.getElementById('inputArea');
            const chatHistory = document.getElementById('chatHistory');
            
            if (inputArea) {
                // 强制设置输入框样式
                inputArea.style.setProperty('position', 'fixed', 'important');
                inputArea.style.setProperty('bottom', '0', 'important');
                inputArea.style.setProperty('left', '0', 'important');
                inputArea.style.setProperty('right', '0', 'important');
                inputArea.style.setProperty('z-index', '9999', 'important');
                
                setTimeout(() => {
                    const inputHeight = inputArea.offsetHeight;
                    const safeAreaBottom = getComputedStyle(document.documentElement).getPropertyValue('--safe-area-inset-bottom') || '0px';
                    const safeAreaValue = parseInt(safeAreaBottom) || 0;
                    const totalInputHeight = inputHeight + safeAreaValue + 40;
                    
                    if (chatHistory && isChatMode) {
                        const navHeight = 76;
                        const availableHeight = window.innerHeight - navHeight - totalInputHeight;
                        chatHistory.style.setProperty('height', `${availableHeight}px`, 'important');
                        chatHistory.style.setProperty('padding-bottom', `${totalInputHeight}px`, 'important');
                    }
                    
                    updateDebugInfo();
                }, 50);
            }
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            input.value = '';
            
            // 模拟AI回复
            setTimeout(() => {
                addMessage(`收到你的消息：${message}`, 'ai');
            }, 1000);
        }

        function addMessage(content, type) {
            const chatHistory = document.getElementById('chatHistory');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = content;
            chatHistory.appendChild(messageDiv);
            
            if (!isChatMode) {
                toggleChatMode();
            }
            
            setTimeout(() => {
                scrollToBottom();
                fixLayout();
            }, 100);
        }

        function addTestMessage() {
            messageCount++;
            addMessage(`这是测试消息 #${messageCount}，用于测试聊天框的显示效果。`, 'ai');
        }

        function resetLayout() {
            const inputArea = document.getElementById('inputArea');
            const chatHistory = document.getElementById('chatHistory');
            
            // 清除所有强制样式
            if (inputArea) {
                inputArea.style.cssText = '';
                inputArea.className = 'input-area';
            }
            
            if (chatHistory) {
                chatHistory.style.cssText = '';
                chatHistory.className = 'chat-history';
            }
            
            // 重新应用基础样式
            setTimeout(() => {
                updateDebugInfo();
            }, 100);
        }

        function clearMessages() {
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = '<div class="message ai-message">你好！我是AI助手，有什么可以帮助你的吗？</div>';
            messageCount = 0;
            
            // 如果在聊天模式，退出到普通模式
            if (isChatMode) {
                toggleChatMode();
            }
        }

        // 监听各种事件
        window.addEventListener('resize', () => {
            setTimeout(updateDebugInfo, 100);
        });

        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                fixLayout();
                updateDebugInfo();
            }, 500);
        });

        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                setTimeout(updateDebugInfo, 100);
            });
        }

        // 输入框事件
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('messageInput').addEventListener('focus', () => {
            setTimeout(() => {
                fixLayout();
                updateDebugInfo();
            }, 300);
        });

        // 定期更新调试信息
        setInterval(updateDebugInfo, 1000);

        // 初始化
        setTimeout(() => {
            updateDebugInfo();
            fixLayout();
        }, 100);
    </script>
</body>
</html> 
