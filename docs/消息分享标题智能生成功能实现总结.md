# 消息分享标题智能生成功能实现总结

## 功能概述

优化了消息分享功能的标题生成逻辑，从使用整个会话标题改为基于单条消息内容和类型智能生成标题，更准确地反映被分享消息的实际内容。

## 问题分析

### 原有问题
1. **标题来源不匹配**：分享的是单条AI回复消息和其对应的用户消息，但使用的是整个会话标题
2. **量化分析消息特殊性**：量化分析消息可能没有对应的用户消息，直接使用会话标题不合适
3. **标题缺乏针对性**：所有消息都使用相同的会话标题，无法体现消息的具体内容

### 用户体验影响
- 智能荐股分享显示会话标题而非"AI智能荐股推荐"
- 自选股查看分享可能显示"AI智能分析"而非"我的自选股列表"
- 量化分析报告分享标题不够具体

## 解决方案

### 1. 智能标题生成策略

实现了基于优先级的标题生成逻辑：

```javascript
const generateShareTitle = () => {
    const message = props.message;
    
    // 优先级1: 基于消息类型生成标题
    if (message.messageType) {
        switch (message.messageType) {
            case 'smart_recommendation': return 'AI智能荐股推荐';
            case 'watchlist_view': return '我的自选股列表';
            case 'asset_analysis': return '投资组合分析';
            case 'news_update': return '今日财经资讯';
            case 'smart_review': return '智能投资复盘';
            case 'individual_stock_query':
                if (message.stockInfo && message.stockInfo.name) {
                    return `${message.stockInfo.name}(${message.stockInfo.code})分析`;
                }
                return '个股分析报告';
        }
    }
    
    // 优先级2: 基于消息特征生成标题
    // 量化分析消息特殊处理
    if (message.isQuantAnalysis && message.stockInfo) {
        return `${message.stockInfo.name}(${message.stockInfo.code})量化分析`;
    }
    
    // 优先级3: 基于用户消息内容
    // 优先级4: 基于AI消息内容
    // 优先级5: 默认标题
    return 'AI智能分析';
};
```

### 2. 标题生成规则

#### 消息类型优先级（最高优先级）
- `smart_recommendation` → "AI智能荐股推荐"
- `watchlist_view` → "我的自选股列表"
- `asset_analysis` → "投资组合分析"
- `news_update` → "今日财经资讯"
- `smart_review` → "智能投资复盘"
- `individual_stock_query` → "股票名称(代码)分析" 或 "个股分析报告"

#### 消息特征判断（第二优先级）
- **量化分析消息**：使用股票信息生成 "股票名称(代码)量化分析"
- **智能荐股消息**：检查 `hasStockInfo`、`stockList`、`isRecommendation` 属性
- **自选股消息**：检查 `isWatchlistDisplay`、`watchlistData`、`hasWatchlistInfo` 属性
- **资产分析消息**：检查 `hasAssetInfo`、`assetData`、`isAssetAnalysis` 属性
- **资讯推送消息**：检查 `isNewsUpdate` 属性

#### 用户消息内容（第三优先级）
如果有对应的用户消息，提取前20个字符作为标题

#### AI消息内容（第四优先级）
基于AI消息内容中的关键词匹配生成相应标题

#### 默认标题（最低优先级）
如果以上都无法确定，使用 "AI智能分析"

## 技术实现

### 核心代码修改

#### 1. 新增智能标题生成函数
```javascript
// 智能生成分享标题
const generateShareTitle = () => {
    // 基于消息类型、特征、内容生成合适的标题
};
```

#### 2. 更新分享功能
```javascript
// 使用智能生成的分享标题
const title = generateShareTitle();
ctx.fillText(title, 40, headerY);
```

#### 3. 移除不必要的 props
- 移除 `sessionTitle` prop，不再依赖会话标题
- 保留 `chatHistory` 和 `messageIndex` 用于查找对应的用户消息

### 代码影响范围

#### 修改文件
- `src/components/ChatMessage.vue`：添加智能标题生成逻辑
- `src/views/Main.vue`：移除 `session-title` prop 传递

#### 新增功能
- `generateShareTitle()` 函数：智能标题生成核心逻辑
- 基于消息类型的标题映射
- 量化分析消息的特殊处理
- 多级降级策略确保总有合适的标题

## 功能特点

### 1. 针对性强
每种消息类型都有专门的标题，准确反映消息内容

### 2. 智能降级
多级优先级确保即使在边缘情况下也能生成合适的标题

### 3. 特殊处理
- **量化分析消息**：即使没有用户消息也能生成具体的股票分析标题
- **个股查询**：结合股票信息生成包含股票名称和代码的标题
- **用户消息缺失**：基于AI消息内容生成标题

### 4. 用户友好
标题更直观地反映了分享内容的实际主题

## 应用场景对比

### 智能荐股消息
- **优化前**：可能显示 "智能荐股：根据我的投资偏好推荐优质股票..."
- **优化后**：统一显示 "AI智能荐股推荐"

### 自选股查看消息
- **优化前**：可能显示 "查看我的自选股列表" 或 "AI智能分析"
- **优化后**：统一显示 "我的自选股列表"

### 量化分析消息
- **优化前**：显示会话标题（可能不相关）
- **优化后**：显示 "平安银行(000001)量化分析"

### 个股查询消息
- **优化前**：显示用户输入内容的前30字符
- **优化后**：显示 "平安银行(000001)分析"

## 用户体验改进

### 1. 标题一致性
同类型消息的分享标题保持一致，提升品牌形象

### 2. 内容相关性
分享标题直接反映消息内容，提高分享的吸引力

### 3. 专业性
量化分析、个股分析等专业内容有更具体的标题

### 4. 易理解性
标题更简洁明了，便于接收者理解分享内容

## 扩展性考虑

### 1. 新消息类型
可以轻松添加新的消息类型和对应的标题生成规则

### 2. 多语言支持
标题生成逻辑可以扩展支持多语言环境

### 3. 个性化标题
未来可以基于用户偏好或历史行为个性化生成标题

## 总结

通过实现智能标题生成功能，分享功能的用户体验得到显著提升：

1. **更准确**：标题反映实际分享内容而非整个会话主题
2. **更专业**：不同类型的分析报告有专门的标题格式
3. **更友好**：即使在特殊情况下也能生成合适的标题
4. **更一致**：同类型消息使用统一的标题格式

这次优化解决了用户反馈的分享标题不准确问题，特别是量化分析消息和快捷操作生成消息的标题显示问题。 